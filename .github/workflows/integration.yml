name: Integration Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  integration:
    name: Run Integration Tests with Docker
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Copy .env
      run: cp .env.example .env

    - name: Start Docker Services
      run: |
        docker-compose up -d
        sleep 30

    - name: Check Services Health
      run: |
        docker-compose ps
        docker-compose logs app

    - name: Install Dependencies
      run: |
        docker-compose exec -T app composer install --no-interaction --prefer-dist
        docker-compose exec -T app npm ci
        docker-compose exec -T app npm run build

    - name: Generate Application Key
      run: docker-compose exec -T app php artisan key:generate

    - name: Run Migrations
      run: |
        docker-compose exec -T app php artisan migrate --force
        docker-compose exec -T app php artisan migrate --database=radius --path=database/migrations/radius --force

    - name: Seed Database
      run: |
        docker-compose exec -T app php artisan db:seed --class=RoleSeeder --force
        docker-compose exec -T app php artisan db:seed --class=ServicePackageSeeder --force

    - name: Run Integration Tests
      run: docker-compose exec -T app php artisan test --testsuite=Integration

    - name: Test IPAM Service
      run: |
        docker-compose exec -T app php artisan test --filter=IpamIntegrationTest

    - name: Test RADIUS Service
      run: |
        docker-compose exec -T app php artisan test --filter=RadiusIntegrationTest

    - name: Test MikroTik Service
      run: |
        docker-compose exec -T app php artisan test --filter=MikrotikIntegrationTest

    - name: Test API Endpoints
      run: |
        docker-compose exec -T app php artisan test --testsuite=Feature --filter=Api

    - name: Show Logs on Failure
      if: failure()
      run: |
        docker-compose logs app
        docker-compose logs db
        docker-compose logs radius-db

    - name: Stop Docker Services
      if: always()
      run: docker-compose down -v
